<!DOCTYPE html>
<html>
<head>
  <title>County Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">

  <!-- MapLibre GL JS -->
  <link href="https://unpkg.com/maplibre-gl@5.0.0/dist/maplibre-gl.css" rel="stylesheet">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
    }

    /* Full-page map container */
    #mapContainer {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1;
    }

    #map {
      width: 100%;
      height: 100%;
      background: #000011;  /* Deep space background */
    }

    /* Breadcrumb navigation - positioned at top right to avoid sidebar */
    #breadcrumb {
      position: absolute;
      top: 10px;
      right: 120px;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.7);
      padding: 8px 12px;
      border-radius: 4px;
      color: white;
      font-size: 14px;
      max-width: 50%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    #breadcrumb span {
      cursor: pointer;
    }

    #breadcrumb span:hover {
      text-decoration: underline;
    }

    #breadcrumb span.current {
      color: #ff6600;
      cursor: default;
    }

    #breadcrumb span.current:hover {
      text-decoration: none;
    }

    /* Zoom level display */
    #zoomLevel {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.7);
      padding: 8px 12px;
      border-radius: 4px;
      color: white;
      font-size: 14px;
      font-family: monospace;
    }

    /* Admin level buttons - quick zoom to specific levels */
    #levelButtons {
      position: absolute;
      top: 45px;
      right: 10px;
      z-index: 1000;
      display: flex;
      gap: 4px;
    }
    #levelButtons button {
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid #555;
      color: #aaa;
      padding: 4px 8px;
      border-radius: 3px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }
    #levelButtons button:hover {
      background: rgba(50, 50, 50, 0.9);
      color: white;
      border-color: #888;
    }
    #levelButtons button.active {
      background: rgba(255, 102, 0, 0.8);
      color: white;
      border-color: #ff6600;
    }
    /* Lock button - separate from level buttons */
    #levelLockBtn {
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid #555;
      color: #aaa;
      padding: 4px 6px;
      border-radius: 3px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
      margin-left: 4px;
    }
    #levelLockBtn:hover {
      background: rgba(50, 50, 50, 0.9);
      color: white;
      border-color: #888;
    }
    #levelLockBtn.locked {
      background: rgba(200, 50, 50, 0.8);
      color: white;
      border-color: #ff4444;
    }

    /* Overlay Selector - data layer toggles */
    #overlaySelector {
      position: absolute;
      top: 80px;
      right: 10px;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 6px;
      min-width: 140px;
      font-size: 12px;
    }

    .overlay-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      cursor: pointer;
      color: #ddd;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .overlay-header:hover {
      background: rgba(255,255,255,0.05);
    }

    .overlay-title {
      font-weight: 500;
    }

    .overlay-toggle {
      color: #888;
      font-family: monospace;
    }

    .overlay-list {
      padding: 6px 0;
    }

    .overlay-item {
      display: flex;
      align-items: center;
      padding: 6px 12px;
      cursor: pointer;
      color: #bbb;
      gap: 8px;
    }

    .overlay-item:hover {
      background: rgba(255,255,255,0.05);
      color: #fff;
    }

    .overlay-item input[type="checkbox"] {
      margin: 0;
      cursor: pointer;
    }

    .overlay-icon {
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
      color: #888;
    }

    .overlay-item input:checked + .overlay-icon {
      background: #0f4c75;
      color: #fff;
    }

    .overlay-label {
      flex: 1;
    }

    .overlay-label.placeholder {
      color: #666;
      font-style: italic;
    }

    /* Category styles */
    .overlay-category {
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .overlay-category:last-child {
      border-bottom: none;
    }

    .overlay-category-header {
      display: flex;
      align-items: center;
      padding: 6px 12px;
      cursor: pointer;
      color: #ccc;
      gap: 8px;
      font-weight: 500;
    }

    .overlay-category-header:hover {
      background: rgba(255,255,255,0.05);
      color: #fff;
    }

    .overlay-category-header input[type="checkbox"] {
      margin: 0;
      cursor: pointer;
    }

    .overlay-category-header .overlay-icon {
      background: rgba(255,255,255,0.15);
      color: #aaa;
    }

    .overlay-category-header input:checked + .overlay-icon {
      background: #0f4c75;
      color: #fff;
    }

    .category-toggle {
      margin-left: auto;
      color: #666;
      font-family: monospace;
      font-size: 14px;
    }

    .overlay-sub-list {
      background: rgba(0,0,0,0.2);
    }

    .overlay-sub-item {
      padding-left: 32px;
      font-size: 11px;
    }

    .overlay-sub-item .overlay-icon {
      width: 16px;
      height: 16px;
      font-size: 9px;
    }

    .overlay-sub-item input[type="checkbox"]:disabled + .overlay-icon {
      background: rgba(255,255,255,0.05);
      color: #555;
    }

    /* Stats overlay - dark */
    #statsOverlay {
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 1000;
      background: rgba(26,26,46,0.9);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      color: #d0d0d0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    }

    /* Time Slider - dark */
    #timeSliderContainer {
      position: absolute;
      bottom: 50px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: rgba(26,26,46,0.95);
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.4);
      display: none;
      min-width: 300px;
      max-width: 500px;
    }

    #timeSliderContainer.visible {
      display: block;
    }

    .time-slider-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .time-slider-title {
      font-size: 12px;
      font-weight: 600;
      color: #d0d0d0;
    }

    .time-slider-year {
      font-size: 18px;
      font-weight: 700;
      color: #5dade2;
      min-width: 50px;
      text-align: center;
    }

    .time-slider-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #timeSlider {
      flex: 1;
      height: 6px;
      -webkit-appearance: none;
      appearance: none;
      background: #3d3d5c;
      border-radius: 3px;
      outline: none;
    }

    #timeSlider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      background: #0f4c75;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.4);
    }

    #timeSlider::-moz-range-thumb {
      width: 18px;
      height: 18px;
      background: #0f4c75;
      border-radius: 50%;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.4);
    }

    .time-slider-labels {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #888;
      margin-top: 4px;
    }

    /* Time slider buttons */
    .time-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: #2d2d44;
      color: #d0d0d0;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: bold;
      flex-shrink: 0;
    }

    .time-btn:hover {
      background: #3d3d5c;
    }

    .time-btn.play {
      width: 32px;
      height: 32px;
      background: #0f4c75;
      border-radius: 50%;
      font-size: 12px;
    }

    .time-btn.play:hover {
      background: #1a6a9e;
    }

    .time-btn.active {
      background: #ff6600;
      color: white;
    }

    /* Time slider tabs (multi-scale) */
    .time-slider-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #3d3d5c;
    }

    .time-slider-tab {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: #2d2d44;
      border: 1px solid #3d3d5c;
      border-radius: 4px;
      color: #a0a0a0;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .time-slider-tab:hover {
      background: #3d3d5c;
      color: #d0d0d0;
    }

    .time-slider-tab.active {
      background: #0f4c75;
      border-color: #1a6a9e;
      color: #ffffff;
    }

    .time-slider-tab .tab-label {
      font-weight: 500;
    }

    .time-slider-tab .tab-granularity {
      font-size: 9px;
      padding: 1px 4px;
      background: rgba(0,0,0,0.3);
      border-radius: 2px;
      color: #888;
    }

    .time-slider-tab.active .tab-granularity {
      background: rgba(255,255,255,0.15);
      color: #b0d0e8;
    }

    .time-slider-tab .tab-close {
      margin-left: 4px;
      width: 14px;
      height: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 2px;
      font-size: 10px;
      color: #666;
    }

    /* Metric tabs (above time slider) */
    .metric-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid #3d3d5c;
      flex-wrap: wrap;
    }

    .metric-tab {
      padding: 5px 12px;
      background: #2d2d44;
      border: 1px solid #3d3d5c;
      border-radius: 4px;
      color: #a0a0a0;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .metric-tab:hover {
      background: #3d3d5c;
      color: #d0d0d0;
    }

    .metric-tab.active {
      background: #0f4c75;
      border-color: #1a6a9e;
      color: #ffffff;
    }

    .time-slider-tab .tab-close:hover {
      background: rgba(255,100,100,0.3);
      color: #ff6666;
    }

    /* Choropleth Legend - dark */
    #choroplethLegend {
      position: absolute;
      bottom: 50px;
      right: 10px;  /* Right side to avoid sidebar overlap */
      z-index: 1000;
      background: rgba(26,26,46,0.95);
      padding: 10px 12px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
      display: none;
      min-width: 120px;
    }

    #choroplethLegend.visible {
      display: block;
    }

    .legend-title {
      font-size: 11px;
      font-weight: 600;
      color: #d0d0d0;
      margin-bottom: 6px;
    }

    .legend-gradient {
      height: 12px;
      border-radius: 2px;
      margin-bottom: 4px;
    }

    .legend-labels {
      display: flex;
      justify-content: space-between;
      font-size: 10px;
      color: #888;
    }

    /* Sidebar toggle button */
    #sidebarToggle {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1001;
      width: 44px;
      height: 44px;
      background: #1a1a2e;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all 0.3s;
      color: #e8e8e8;
    }

    #sidebarToggle:hover {
      background: #2d2d44;
    }

    #sidebarToggle.hidden {
      left: 10px;
    }

    /* Sidebar */
    #sidebar {
      position: absolute;
      top: 0;
      left: 0;
      width: 400px;
      height: 100%;
      background: #1a1a2e;
      z-index: 1000;
      box-shadow: 2px 0 10px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
      transform: translateX(0);
      transition: transform 0.3s ease;
    }

    #sidebar.collapsed {
      transform: translateX(-100%);
    }

    /* Sidebar width resize handle */
    #sidebarResizeHandle {
      position: absolute;
      top: 0;
      right: 0;
      width: 6px;
      height: 100%;
      cursor: ew-resize;
      background: transparent;
      z-index: 1001;
      transition: background 0.2s ease;
    }

    #sidebarResizeHandle:hover,
    #sidebarResizeHandle.active {
      background: rgba(0, 123, 255, 0.3);
    }

    /* Sidebar header */
    #sidebarHeader {
      padding: 15px;
      background: #16213e;
      color: #e8e8e8;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #sidebarHeader h2 {
      font-size: 18px;
      font-weight: 600;
    }

    #closeSidebar {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 0 5px;
    }

    /* Chat container */
    #chatContainer {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Chat messages area */
    #chatMessages {
      flex: 1;
      min-height: 100px;
      overflow-y: auto;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .chat-message {
      max-width: 90%;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.4;
    }

    .chat-message.user {
      align-self: flex-end;
      background: #0f4c75;
      color: #e8e8e8;
      border-bottom-right-radius: 4px;
    }

    .chat-message.assistant {
      align-self: flex-start;
      background: #2d2d44;
      color: #d0d0d0;
      border-bottom-left-radius: 4px;
    }

    .chat-message.system {
      align-self: center;
      background: #3d3d2e;
      color: #c9b458;
      font-size: 12px;
      padding: 8px 12px;
    }

    /* Show on map button */
    .show-on-map-btn {
      display: inline-block;
      margin-top: 8px;
      padding: 6px 12px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }

    .show-on-map-btn:hover {
      background: #218838;
    }

    /* Chat input area */
    #chatInputArea {
      padding: 15px;
      background: #16213e;
      height: 140px;
      min-height: 80px;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    #chatForm {
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex: 1;
    }

    #chatInput {
      flex: 1;
      padding: 12px;
      border: 1px solid #3d3d5c;
      border-radius: 8px;
      font-size: 14px;
      resize: none;
      min-height: 40px;
      background: #1a1a2e;
      color: #e8e8e8;
    }

    #chatInput:focus {
      outline: none;
      border-color: #0f4c75;
    }

    #chatInput::placeholder {
      color: #666;
    }

    #sendBtn {
      padding: 12px 20px;
      background: #0f4c75;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    #sendBtn:hover {
      background: #1a6a9e;
    }

    #sendBtn:disabled {
      background: #3d3d5c;
      color: #666;
      cursor: not-allowed;
    }

    /* Order Panel */
    #orderPanel {
      padding: 12px 15px;
      background: #0f0f1a;
      height: 160px;
      min-height: 60px;
      overflow-y: auto;
      flex-shrink: 0;
    }

    #orderPanel h4 {
      font-size: 13px;
      font-weight: 600;
      color: #c0c0c0;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #orderPanel h4 span {
      color: #888;
      font-weight: normal;
      font-size: 11px;
    }

    .order-items {
      margin-bottom: 12px;
    }

    .order-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 10px;
      background: #1a1a2e;
      border: 1px solid #3d3d5c;
      border-radius: 6px;
      margin-bottom: 6px;
      font-size: 13px;
    }

    .order-item-info {
      flex: 1;
    }

    .order-item-name {
      font-weight: 500;
      color: #d0d0d0;
    }

    .order-item-details {
      font-size: 11px;
      color: #888;
      margin-top: 2px;
    }

    .order-item-remove {
      background: none;
      border: none;
      color: #999;
      font-size: 18px;
      cursor: pointer;
      padding: 0 5px;
      line-height: 1;
    }

    .order-item-remove:hover {
      color: #dc3545;
    }

    .order-item-invalid {
      background: #2a1a1a;
      border-left: 3px solid #dc3545;
    }

    .order-item-invalid .order-item-name {
      color: #ff6b6b;
    }

    .order-item-error {
      font-size: 10px;
      color: #dc3545;
      margin-top: 2px;
      font-style: italic;
    }

    .order-item-location {
      background: #2a2010;
      border-left: 3px solid #ffaa00;
    }

    .order-item-location .order-item-name {
      color: #ffcc44;
    }

    .order-item-location .order-item-details {
      color: #aa9955;
    }

    .order-actions {
      display: flex;
      gap: 8px;
    }

    .order-btn {
      flex: 1;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .order-btn.confirm {
      background: #28a745;
      color: white;
    }

    .order-btn.confirm:hover {
      background: #218838;
    }

    .order-btn.confirm:disabled {
      background: #3d3d5c;
      color: #666;
      cursor: not-allowed;
    }

    .order-btn.cancel {
      background: #3d3d5c;
      color: #d0d0d0;
    }

    .order-btn.cancel:hover {
      background: #4d4d6c;
    }

    .order-summary {
      font-size: 12px;
      color: #888;
      margin-bottom: 10px;
      font-style: italic;
    }

    /* Sidebar footer with settings link */
    #sidebarFooter {
      padding: 10px 15px;
      border-top: 1px solid #3d3d5c;
      background: #16213e;
      text-align: center;
    }

    #settingsLink {
      color: #888;
      text-decoration: none;
      font-size: 13px;
      cursor: pointer;
    }

    #settingsLink:hover {
      color: #5dade2;
    }

    /* Settings view */
    #settingsView {
      display: none;
      flex-direction: column;
      height: 100%;
      overflow-y: auto;
    }

    #settingsView.active {
      display: flex;
    }

    #chatContainer.hidden {
      display: none;
    }

    .settings-content {
      padding: 20px;
      flex: 1;
    }

    .settings-section {
      margin-bottom: 25px;
    }

    .settings-section h3 {
      font-size: 14px;
      font-weight: 600;
      color: #d0d0d0;
      margin-bottom: 10px;
      padding-bottom: 5px;
      border-bottom: 1px solid #3d3d5c;
    }

    .settings-section p {
      font-size: 12px;
      color: #888;
      margin-bottom: 10px;
    }

    .settings-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #3d3d5c;
      border-radius: 6px;
      font-size: 13px;
      font-family: monospace;
      background: #1a1a2e;
      color: #e8e8e8;
    }

    .settings-input:focus {
      outline: none;
      border-color: #0f4c75;
    }

    .settings-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      margin-right: 10px;
      margin-top: 10px;
    }

    .settings-btn.primary {
      background: #0f4c75;
      color: white;
    }

    .settings-btn.primary:hover {
      background: #1a6a9e;
    }

    .settings-btn.secondary {
      background: #3d3d5c;
      color: #d0d0d0;
    }

    .settings-btn.secondary:hover {
      background: #4d4d6c;
    }

    .settings-status {
      margin-top: 10px;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      display: none;
    }

    .settings-status.success {
      display: block;
      background: #1a3d2e;
      color: #7dcea0;
    }

    .settings-status.error {
      display: block;
      background: #3d1a1a;
      color: #e74c3c;
    }

    .folder-structure {
      font-family: monospace;
      font-size: 12px;
      background: #0f0f1a;
      padding: 12px;
      border-radius: 6px;
      color: #888;
      margin-top: 10px;
    }

    .settings-footer {
      padding: 10px 15px;
      border-top: 1px solid #3d3d5c;
      background: #16213e;
      text-align: center;
    }

    .settings-footer a {
      color: #888;
      text-decoration: none;
      font-size: 13px;
      cursor: pointer;
    }

    .settings-footer a:hover {
      color: #5dade2;
    }

    /* Resize handles - dark */
    .resize-handle {
      height: 8px;
      background: #2d2d44;
      cursor: ns-resize;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background 0.2s;
    }

    .resize-handle:hover,
    .resize-handle.active {
      background: #0f4c75;
    }

    .resize-handle::after {
      content: '';
      width: 40px;
      height: 3px;
      background: #666;
      border-radius: 2px;
    }

    .resize-handle:hover::after,
    .resize-handle.active::after {
      background: white;
    }

    /* Typing indicator - dark */
    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 10px 14px;
      background: #2d2d44;
      border-radius: 12px;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    .typing-indicator span {
      width: 8px;
      height: 8px;
      background: #666;
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }

    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-4px); }
    }

    /* MapLibre popup styling - compact sizing */
    .maplibregl-popup-content {
      padding: 10px 12px;
      font-size: 13px;
      line-height: 1.35;
    }

    .maplibregl-popup-content strong {
      font-size: 14px;
      display: block;
      margin-bottom: 5px;
      color: #333;
    }

    .maplibregl-popup-close-button {
      font-size: 16px;
      padding: 4px 6px;
    }

    /* Responsive */
    @media (max-width: 500px) {
      #sidebar {
        width: 100%;
      }
    }

    /* Selection Mode (disambiguation) */
    #map.selection-mode {
      cursor: crosshair;
    }

    .selection-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      pointer-events: none;
      z-index: 2000;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .selection-overlay.visible {
      opacity: 1;
    }

    .selection-overlay-content {
      position: absolute;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(26, 26, 46, 0.95);
      border: 1px solid #ff8800;
      border-radius: 8px;
      padding: 16px 24px;
      color: white;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      max-width: 400px;
    }

    .selection-overlay-title {
      font-size: 18px;
      font-weight: 600;
      color: #ffaa00;
      margin-bottom: 8px;
    }

    .selection-overlay-subtitle {
      font-size: 14px;
      color: #aaa;
      margin-bottom: 12px;
    }

    .selection-options-list {
      text-align: left;
      margin-bottom: 12px;
    }

    .selection-option-label {
      font-size: 13px;
      color: #ddd;
      padding: 4px 0;
    }

    .selection-overlay-hint {
      font-size: 12px;
      color: #888;
      font-style: italic;
    }

    /* Selection mode numbered markers */
    .selection-marker {
      width: 32px;
      height: 32px;
      background: #ff8800;
      border: 3px solid #ffffff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.5);
      transition: transform 0.15s ease, background 0.15s ease;
    }

    .selection-marker:hover {
      transform: scale(1.15);
      background: #ffaa00;
    }

    .selection-marker-number {
      color: white;
      font-size: 14px;
      font-weight: 700;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <!-- Sidebar Toggle Button (visible when sidebar is collapsed) -->
  <button id="sidebarToggle" title="Open chat">
    <span>&#9776;</span>
  </button>

  <!-- Sidebar -->
  <div id="sidebar">
    <div id="sidebarResizeHandle" title="Drag to resize"></div>
    <div id="sidebarHeader">
      <h2>Map Explorer</h2>
      <button id="closeSidebar" title="Close">&times;</button>
    </div>

    <div id="chatContainer">
      <div id="chatMessages">
        <div class="chat-message assistant">
          Welcome! I can help you explore geographic data.
          <br><br>
          To build a map query, I need three things: <b>location</b> (where), <b>time period</b> (when), and <b>data</b> (what). Feel free to ask what's available before diving in.
          <br><br>
          Check the <b>overlays</b> on the right to help clarify what you want to see.
          <br><br>
          Try: "What data do you have for Europe?" or "Show me CO2 emissions trends worldwide"
        </div>
      </div>

      <!-- Resize handle between messages and input -->
      <div class="resize-handle" id="resizeInput" title="Drag to resize"></div>

      <div id="chatInputArea">
        <form id="chatForm">
          <textarea id="chatInput" placeholder="Ask about locations, data, or comparisons..." rows="1"></textarea>
          <button type="submit" id="sendBtn">Send</button>
        </form>
      </div>

      <!-- Resize handle between input and order panel -->
      <div class="resize-handle" id="resizeOrder" title="Drag to resize"></div>

      <!-- Order Panel -->
      <div id="orderPanel">
        <h4>Your Order <span id="orderCount"></span></h4>
        <div class="order-summary" id="orderSummary"></div>
        <div class="order-items" id="orderItems"></div>
        <div class="order-actions">
          <button class="order-btn cancel" id="orderCancelBtn">Clear</button>
          <button class="order-btn confirm" id="orderConfirmBtn">Display on Map</button>
        </div>
      </div>
    </div>

    <!-- Settings View (hidden by default) -->
    <div id="settingsView">
      <div class="settings-content">
        <div class="settings-section">
          <h3>Data Storage</h3>
          <p>Configure an external folder for storing large geometry and data files. This keeps your git repository small.</p>

          <label for="backupPathInput" style="font-size: 12px; font-weight: 500; display: block; margin-bottom: 5px; color: #d0d0d0;">
            Backup Folder Path:
          </label>
          <input type="text" id="backupPathInput" class="settings-input"
                 placeholder="e.g., D:\county-map-data or /home/user/county-map-data">

          <div class="folder-structure">
            Folder structure:<br>
            [backup_path]/<br>
            &nbsp;&nbsp;geometry/&nbsp;&nbsp;&nbsp;-- admin boundaries (GADM, Natural Earth)<br>
            &nbsp;&nbsp;data/&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- indicator datasets (parquet/CSV)<br>
            &nbsp;&nbsp;metadata/&nbsp;&nbsp;&nbsp;-- catalog and index files
          </div>

          <button type="button" id="saveSettingsBtn" class="settings-btn primary">Save Settings</button>
          <button type="button" id="initFoldersBtn" class="settings-btn secondary">Initialize Folders</button>

          <div id="settingsStatus" class="settings-status"></div>
        </div>

        <div class="settings-section">
          <h3>Current Configuration</h3>
          <div id="currentConfig" style="font-size: 12px; color: #888;">
            Loading...
          </div>
        </div>
      </div>

      <div class="settings-footer">
        <a id="backToChat" href="#">Back to Chat</a>
      </div>
    </div>

    <!-- Sidebar Footer (in chat view) -->
    <div id="sidebarFooter">
      <a id="settingsLink" href="#">Settings</a>
    </div>
  </div>

  <!-- Map Container -->
  <div id="mapContainer">
    <div id="map"></div>
    <div id="breadcrumb"></div>
    <div id="zoomLevel">Zoom: 0.0</div>
    <div id="levelButtons">
      <button data-level="0" title="Countries (zoom ~2)">World</button>
      <button data-level="1" title="States/Provinces (zoom ~5)">States</button>
      <button data-level="2" title="Counties/Districts (zoom ~8)">Counties</button>
      <button data-level="3" title="Subdivisions (zoom ~11)">Local</button>
      <button id="levelLockBtn" title="Lock admin level">Lock</button>
    </div>

    <!-- Overlay Selector -->
    <div id="overlaySelector"></div>
  </div>

  <!-- Stats Overlay -->
  <div id="statsOverlay">
    <span id="totalAreas">0</span> areas
  </div>

  <!-- Time Slider -->
  <div id="timeSliderContainer">
    <!-- Metric tabs (shown when multiple metrics available) -->
    <div id="metricTabs" class="metric-tabs" style="display: none;"></div>
    <!-- Multi-scale tabs (hidden when only one scale) -->
    <div id="timeSliderTabs" class="time-slider-tabs" style="display: none;"></div>
    <div class="time-slider-header">
      <span class="time-slider-title" id="sliderTitle">Year</span>
      <span class="time-slider-year" id="currentYearLabel">2020</span>
    </div>
    <div class="time-slider-controls">
      <button id="rewindBtn" class="time-btn" title="Fast rewind (3x)">&lt;&lt;</button>
      <button id="stepBackBtn" class="time-btn" title="Previous year">&lt;</button>
      <button id="playBtn" class="time-btn play" title="Play/Pause">|&gt;</button>
      <button id="stepFwdBtn" class="time-btn" title="Next year">&gt;</button>
      <button id="fastFwdBtn" class="time-btn" title="Fast forward (3x)">&gt;&gt;</button>
      <input type="range" id="timeSlider" min="2000" max="2023" value="2023">
    </div>
    <div class="time-slider-labels">
      <span id="minYearLabel">2000</span>
      <span id="maxYearLabel">2023</span>
    </div>
  </div>

  <!-- Choropleth Legend -->
  <div id="choroplethLegend">
    <div class="legend-title" id="legendTitle">Value</div>
    <div class="legend-gradient" id="legendGradient"></div>
    <div class="legend-labels">
      <span id="legendMin">0</span>
      <span id="legendMax">100</span>
    </div>
  </div>

  <script src="https://unpkg.com/maplibre-gl@5.0.0/dist/maplibre-gl.js"></script>
  <script type="module" src="/static/modules/app.js"></script>
</body>
</html>
