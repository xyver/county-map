<!DOCTYPE html>
<html>
<head>
  <title>County Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">

  <!-- MapLibre GL JS -->
  <link href="https://unpkg.com/maplibre-gl@5.0.0/dist/maplibre-gl.css" rel="stylesheet">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
    }

    /* Full-page map container */
    #mapContainer {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1;
    }

    #map {
      width: 100%;
      height: 100%;
      background: #000011;  /* Deep space background */
    }

    /* Breadcrumb navigation - positioned at top right to avoid sidebar */
    #breadcrumb {
      position: absolute;
      top: 10px;
      right: 120px;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.7);
      padding: 8px 12px;
      border-radius: 4px;
      color: white;
      font-size: 14px;
      max-width: 50%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    #breadcrumb span {
      cursor: pointer;
    }

    #breadcrumb span:hover {
      text-decoration: underline;
    }

    #breadcrumb span.current {
      color: #ff6600;
      cursor: default;
    }

    #breadcrumb span.current:hover {
      text-decoration: none;
    }

    /* Zoom level display */
    #zoomLevel {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.7);
      padding: 8px 12px;
      border-radius: 4px;
      color: white;
      font-size: 14px;
      font-family: monospace;
    }

    /* Stats overlay */
    #statsOverlay {
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 1000;
      background: rgba(255,255,255,0.9);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    /* Time Slider */
    #timeSliderContainer {
      position: absolute;
      bottom: 50px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: rgba(255,255,255,0.95);
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: none;
      min-width: 300px;
      max-width: 500px;
    }

    #timeSliderContainer.visible {
      display: block;
    }

    .time-slider-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .time-slider-title {
      font-size: 12px;
      font-weight: 600;
      color: #333;
    }

    .time-slider-year {
      font-size: 18px;
      font-weight: 700;
      color: #007bff;
      min-width: 50px;
      text-align: center;
    }

    .time-slider-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #timeSlider {
      flex: 1;
      height: 6px;
      -webkit-appearance: none;
      appearance: none;
      background: #ddd;
      border-radius: 3px;
      outline: none;
    }

    #timeSlider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      background: #007bff;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    #timeSlider::-moz-range-thumb {
      width: 18px;
      height: 18px;
      background: #007bff;
      border-radius: 50%;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .time-slider-labels {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #666;
      margin-top: 4px;
    }

    #playBtn {
      width: 32px;
      height: 32px;
      border: none;
      background: #007bff;
      color: white;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    #playBtn:hover {
      background: #0056b3;
    }

    /* Choropleth Legend */
    #choroplethLegend {
      position: absolute;
      bottom: 50px;
      left: 10px;
      z-index: 1000;
      background: rgba(255,255,255,0.95);
      padding: 10px 12px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      display: none;
      min-width: 120px;
    }

    #choroplethLegend.visible {
      display: block;
    }

    .legend-title {
      font-size: 11px;
      font-weight: 600;
      color: #333;
      margin-bottom: 6px;
    }

    .legend-gradient {
      height: 12px;
      border-radius: 2px;
      margin-bottom: 4px;
    }

    .legend-labels {
      display: flex;
      justify-content: space-between;
      font-size: 10px;
      color: #666;
    }

    /* Sidebar toggle button */
    #sidebarToggle {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1001;
      width: 44px;
      height: 44px;
      background: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all 0.3s;
    }

    #sidebarToggle:hover {
      background: #f0f0f0;
    }

    #sidebarToggle.hidden {
      left: 10px;
    }

    /* Sidebar */
    #sidebar {
      position: absolute;
      top: 0;
      left: 0;
      width: 400px;
      height: 100%;
      background: white;
      z-index: 1000;
      box-shadow: 2px 0 10px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      transform: translateX(0);
      transition: transform 0.3s ease;
    }

    #sidebar.collapsed {
      transform: translateX(-100%);
    }

    /* Sidebar width resize handle */
    #sidebarResizeHandle {
      position: absolute;
      top: 0;
      right: 0;
      width: 6px;
      height: 100%;
      cursor: ew-resize;
      background: transparent;
      z-index: 1001;
      transition: background 0.2s ease;
    }

    #sidebarResizeHandle:hover,
    #sidebarResizeHandle.active {
      background: rgba(0, 123, 255, 0.3);
    }

    /* Sidebar header */
    #sidebarHeader {
      padding: 15px;
      background: #007bff;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #sidebarHeader h2 {
      font-size: 18px;
      font-weight: 600;
    }

    #closeSidebar {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 0 5px;
    }

    /* Chat container */
    #chatContainer {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Chat messages area */
    #chatMessages {
      flex: 1;
      min-height: 100px;
      overflow-y: auto;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .chat-message {
      max-width: 90%;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.4;
    }

    .chat-message.user {
      align-self: flex-end;
      background: #007bff;
      color: white;
      border-bottom-right-radius: 4px;
    }

    .chat-message.assistant {
      align-self: flex-start;
      background: #f0f0f0;
      color: #333;
      border-bottom-left-radius: 4px;
    }

    .chat-message.system {
      align-self: center;
      background: #fff3cd;
      color: #856404;
      font-size: 12px;
      padding: 8px 12px;
    }

    /* Show on map button */
    .show-on-map-btn {
      display: inline-block;
      margin-top: 8px;
      padding: 6px 12px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }

    .show-on-map-btn:hover {
      background: #218838;
    }

    /* Chat input area */
    #chatInputArea {
      padding: 15px;
      background: #fafafa;
      height: 140px;
      min-height: 80px;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    #chatForm {
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex: 1;
    }

    #chatInput {
      flex: 1;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      resize: none;
      min-height: 40px;
    }

    #chatInput:focus {
      outline: none;
      border-color: #007bff;
    }

    #sendBtn {
      padding: 12px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    #sendBtn:hover {
      background: #0056b3;
    }

    #sendBtn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* Order Panel */
    #orderPanel {
      padding: 12px 15px;
      background: #f8f9fa;
      height: 160px;
      min-height: 60px;
      overflow-y: auto;
      flex-shrink: 0;
    }

    #orderPanel h4 {
      font-size: 13px;
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #orderPanel h4 span {
      color: #666;
      font-weight: normal;
      font-size: 11px;
    }

    .order-items {
      margin-bottom: 12px;
    }

    .order-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 10px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      margin-bottom: 6px;
      font-size: 13px;
    }

    .order-item-info {
      flex: 1;
    }

    .order-item-name {
      font-weight: 500;
      color: #333;
    }

    .order-item-details {
      font-size: 11px;
      color: #666;
      margin-top: 2px;
    }

    .order-item-remove {
      background: none;
      border: none;
      color: #999;
      font-size: 18px;
      cursor: pointer;
      padding: 0 5px;
      line-height: 1;
    }

    .order-item-remove:hover {
      color: #dc3545;
    }

    .order-item-invalid {
      background: #fff5f5;
      border-left: 3px solid #dc3545;
    }

    .order-item-invalid .order-item-name {
      color: #dc3545;
    }

    .order-item-error {
      font-size: 10px;
      color: #dc3545;
      margin-top: 2px;
      font-style: italic;
    }

    .order-actions {
      display: flex;
      gap: 8px;
    }

    .order-btn {
      flex: 1;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .order-btn.confirm {
      background: #28a745;
      color: white;
    }

    .order-btn.confirm:hover {
      background: #218838;
    }

    .order-btn.confirm:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .order-btn.cancel {
      background: #6c757d;
      color: white;
    }

    .order-btn.cancel:hover {
      background: #545b62;
    }

    .order-summary {
      font-size: 12px;
      color: #666;
      margin-bottom: 10px;
      font-style: italic;
    }

    /* Sidebar footer with settings link */
    #sidebarFooter {
      padding: 10px 15px;
      border-top: 1px solid #eee;
      background: #f5f5f5;
      text-align: center;
    }

    #settingsLink {
      color: #666;
      text-decoration: none;
      font-size: 13px;
      cursor: pointer;
    }

    #settingsLink:hover {
      color: #007bff;
    }

    /* Settings view */
    #settingsView {
      display: none;
      flex-direction: column;
      height: 100%;
      overflow-y: auto;
    }

    #settingsView.active {
      display: flex;
    }

    #chatContainer.hidden {
      display: none;
    }

    .settings-content {
      padding: 20px;
      flex: 1;
    }

    .settings-section {
      margin-bottom: 25px;
    }

    .settings-section h3 {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
      padding-bottom: 5px;
      border-bottom: 1px solid #eee;
    }

    .settings-section p {
      font-size: 12px;
      color: #666;
      margin-bottom: 10px;
    }

    .settings-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
      font-family: monospace;
    }

    .settings-input:focus {
      outline: none;
      border-color: #007bff;
    }

    .settings-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      margin-right: 10px;
      margin-top: 10px;
    }

    .settings-btn.primary {
      background: #007bff;
      color: white;
    }

    .settings-btn.primary:hover {
      background: #0056b3;
    }

    .settings-btn.secondary {
      background: #6c757d;
      color: white;
    }

    .settings-btn.secondary:hover {
      background: #545b62;
    }

    .settings-status {
      margin-top: 10px;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      display: none;
    }

    .settings-status.success {
      display: block;
      background: #d4edda;
      color: #155724;
    }

    .settings-status.error {
      display: block;
      background: #f8d7da;
      color: #721c24;
    }

    .folder-structure {
      font-family: monospace;
      font-size: 12px;
      background: #f8f9fa;
      padding: 12px;
      border-radius: 6px;
      color: #495057;
      margin-top: 10px;
    }

    .settings-footer {
      padding: 10px 15px;
      border-top: 1px solid #eee;
      background: #f5f5f5;
      text-align: center;
    }

    .settings-footer a {
      color: #666;
      text-decoration: none;
      font-size: 13px;
      cursor: pointer;
    }

    .settings-footer a:hover {
      color: #007bff;
    }

    /* Resize handles */
    .resize-handle {
      height: 8px;
      background: #e0e0e0;
      cursor: ns-resize;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background 0.2s;
    }

    .resize-handle:hover,
    .resize-handle.active {
      background: #007bff;
    }

    .resize-handle::after {
      content: '';
      width: 40px;
      height: 3px;
      background: #999;
      border-radius: 2px;
    }

    .resize-handle:hover::after,
    .resize-handle.active::after {
      background: white;
    }

    /* Typing indicator */
    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 10px 14px;
      background: #f0f0f0;
      border-radius: 12px;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    .typing-indicator span {
      width: 8px;
      height: 8px;
      background: #999;
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }

    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-4px); }
    }

    /* MapLibre popup styling */
    .maplibregl-popup-content {
      padding: 15px;
      max-width: 300px;
      font-size: 13px;
      line-height: 1.5;
    }

    .maplibregl-popup-content strong {
      font-size: 15px;
      display: block;
      margin-bottom: 8px;
      color: #333;
    }

    .maplibregl-popup-close-button {
      font-size: 18px;
      padding: 5px 8px;
    }

    /* Responsive */
    @media (max-width: 500px) {
      #sidebar {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar Toggle Button (visible when sidebar is collapsed) -->
  <button id="sidebarToggle" title="Open chat">
    <span>&#9776;</span>
  </button>

  <!-- Sidebar -->
  <div id="sidebar">
    <div id="sidebarResizeHandle" title="Drag to resize"></div>
    <div id="sidebarHeader">
      <h2>Map Explorer</h2>
      <button id="closeSidebar" title="Close">&times;</button>
    </div>

    <div id="chatContainer">
      <div id="chatMessages">
        <div class="chat-message assistant">
          Welcome! I can help you explore geographic data.
          <br><br>
          Start by asking me about any topic - countries, states, counties, or specific data like GDP, population, or emissions.
          <br><br>
          After we narrow down your request, I'll display the results on the map.
          <br><br>
          Try: "What GDP data do you have?" or "Top 10 countries by CO2 emissions"
        </div>
      </div>

      <!-- Resize handle between messages and input -->
      <div class="resize-handle" id="resizeInput" title="Drag to resize"></div>

      <div id="chatInputArea">
        <form id="chatForm">
          <textarea id="chatInput" placeholder="Ask about locations, data, or comparisons..." rows="1"></textarea>
          <button type="submit" id="sendBtn">Send</button>
        </form>
      </div>

      <!-- Resize handle between input and order panel -->
      <div class="resize-handle" id="resizeOrder" title="Drag to resize"></div>

      <!-- Order Panel -->
      <div id="orderPanel">
        <h4>Your Order <span id="orderCount"></span></h4>
        <div class="order-summary" id="orderSummary"></div>
        <div class="order-items" id="orderItems"></div>
        <div class="order-actions">
          <button class="order-btn cancel" id="orderCancelBtn">Clear</button>
          <button class="order-btn confirm" id="orderConfirmBtn">Display on Map</button>
        </div>
      </div>
    </div>

    <!-- Settings View (hidden by default) -->
    <div id="settingsView">
      <div class="settings-content">
        <div class="settings-section">
          <h3>Data Storage</h3>
          <p>Configure an external folder for storing large geometry and data files. This keeps your git repository small.</p>

          <label for="backupPathInput" style="font-size: 12px; font-weight: 500; display: block; margin-bottom: 5px;">
            Backup Folder Path:
          </label>
          <input type="text" id="backupPathInput" class="settings-input"
                 placeholder="e.g., D:\county-map-data or /home/user/county-map-data">

          <div class="folder-structure">
            Folder structure:<br>
            [backup_path]/<br>
            &nbsp;&nbsp;geometry/&nbsp;&nbsp;&nbsp;-- admin boundaries (GADM, Natural Earth)<br>
            &nbsp;&nbsp;data/&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- indicator datasets (parquet/CSV)<br>
            &nbsp;&nbsp;metadata/&nbsp;&nbsp;&nbsp;-- catalog and index files
          </div>

          <button type="button" id="saveSettingsBtn" class="settings-btn primary">Save Settings</button>
          <button type="button" id="initFoldersBtn" class="settings-btn secondary">Initialize Folders</button>

          <div id="settingsStatus" class="settings-status"></div>
        </div>

        <div class="settings-section">
          <h3>Current Configuration</h3>
          <div id="currentConfig" style="font-size: 12px; color: #666;">
            Loading...
          </div>
        </div>
      </div>

      <div class="settings-footer">
        <a id="backToChat" href="#">Back to Chat</a>
      </div>
    </div>

    <!-- Sidebar Footer (in chat view) -->
    <div id="sidebarFooter">
      <a id="settingsLink" href="#">Settings</a>
    </div>
  </div>

  <!-- Map Container -->
  <div id="mapContainer">
    <div id="map"></div>
    <div id="breadcrumb"></div>
    <div id="zoomLevel">Zoom: 0.0</div>
  </div>

  <!-- Stats Overlay -->
  <div id="statsOverlay">
    <span id="totalAreas">0</span> areas
  </div>

  <!-- Time Slider -->
  <div id="timeSliderContainer">
    <div class="time-slider-header">
      <span class="time-slider-title" id="sliderTitle">Year</span>
      <span class="time-slider-year" id="currentYearLabel">2020</span>
    </div>
    <div class="time-slider-controls">
      <button id="playBtn" title="Play/Pause">|></button>
      <input type="range" id="timeSlider" min="2000" max="2023" value="2023">
    </div>
    <div class="time-slider-labels">
      <span id="minYearLabel">2000</span>
      <span id="maxYearLabel">2023</span>
    </div>
  </div>

  <!-- Choropleth Legend -->
  <div id="choroplethLegend">
    <div class="legend-title" id="legendTitle">Value</div>
    <div class="legend-gradient" id="legendGradient"></div>
    <div class="legend-labels">
      <span id="legendMin">0</span>
      <span id="legendMax">100</span>
    </div>
  </div>

  <script src="https://unpkg.com/maplibre-gl@5.0.0/dist/maplibre-gl.js"></script>
  <script src="/static/config.js"></script>
  <script src="/static/mapviewer.js"></script>
</body>
</html>
