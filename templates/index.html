<!DOCTYPE html>
<html>
<head>
  <title>County Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">

  <!-- MapLibre GL JS -->
  <link href="https://unpkg.com/maplibre-gl@5.0.0/dist/maplibre-gl.css" rel="stylesheet">

  <!-- Map styles (controls, overlays, popups, time slider) -->
  <link rel="stylesheet" href="/static/styles/map.css">
  <!-- Chat panel styles (sidebar, messages, orders, settings) -->
  <link rel="stylesheet" href="/static/styles/chat.css">
</head>
<body>
  <!-- Sidebar Toggle Button (visible when sidebar is collapsed) -->
  <button id="sidebarToggle" title="Open chat">
    <span>&#9776;</span>
  </button>

  <!-- Sidebar -->
  <div id="sidebar">
    <div id="sidebarResizeHandle" title="Drag to resize"></div>
    <div id="sidebarHeader">
      <h2>Map Explorer</h2>
      <div id="sidebarHeaderButtons">
        <button id="newChatBtn" title="Start new chat session">New Chat</button>
        <button id="closeSidebar" title="Close">&times;</button>
      </div>
    </div>

    <div id="chatContainer">
      <div id="chatMessages">
        <div class="chat-message assistant">
          Welcome! I can help you explore geographic data.
          <br><br>
          To build a map query, I need three things: <b>location</b> (where), <b>time period</b> (when), and <b>data</b> (what). Feel free to ask what's available before diving in.
          <br><br>
          Check the <b>overlays</b> on the right to help clarify what you want to see.
          <br><br>
          Try: "What data do you have for Europe?" or "Show me CO2 emissions trends worldwide"
        </div>
      </div>

      <!-- Resize handle between messages and input -->
      <div class="resize-handle" id="resizeInput" title="Drag to resize"></div>

      <div id="chatInputArea">
        <form id="chatForm">
          <textarea id="chatInput" placeholder="Ask about locations, data, or comparisons..." rows="1"></textarea>
          <button type="submit" id="sendBtn">Send</button>
        </form>
      </div>

      <!-- Resize handle between input and order panel -->
      <div class="resize-handle" id="resizeOrder" title="Drag to resize"></div>

      <!-- Order Panel -->
      <div id="orderPanel">
        <div class="order-tabs-header">
          <button class="order-tab active" id="orderTabBtn" data-tab="order">Order <span id="orderCount"></span></button>
          <button class="order-tab" id="loadedTabBtn" data-tab="loaded">Loaded</button>
        </div>
        <!-- Order Tab Content -->
        <div class="order-tab-content active" id="orderTabContent" data-tab="order">
          <div class="order-summary" id="orderSummary"></div>
          <div class="order-items" id="orderItems"></div>
          <div class="order-actions">
            <button class="order-btn cancel" id="orderCancelBtn">Clear</button>
            <button class="order-btn confirm" id="orderConfirmBtn">Display on Map</button>
          </div>
        </div>
        <!-- Loaded Tab Content -->
        <div class="order-tab-content" id="loadedTabContent" data-tab="loaded">
          <div class="loaded-items" id="loadedItems">
            <div style="color: #999; font-size: 12px; text-align: center; padding: 10px;">No data loaded</div>
          </div>
          <div class="loaded-actions" id="loadedActions" style="display: none;">
            <button class="order-btn cancel" id="loadedClearAllBtn">Clear All</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings View (hidden by default) -->
    <div id="settingsView">
      <div class="settings-content">
        <div class="settings-section">
          <h3>Data Storage</h3>
          <p>Configure an external folder for storing large geometry and data files. This keeps your git repository small.</p>

          <label for="backupPathInput" style="font-size: 12px; font-weight: 500; display: block; margin-bottom: 5px; color: #d0d0d0;">
            Backup Folder Path:
          </label>
          <input type="text" id="backupPathInput" class="settings-input"
                 placeholder="e.g., D:\county-map-data or /home/user/county-map-data">

          <div class="folder-structure">
            Folder structure:<br>
            [backup_path]/<br>
            &nbsp;&nbsp;geometry/&nbsp;&nbsp;&nbsp;-- admin boundaries (GADM, Natural Earth)<br>
            &nbsp;&nbsp;data/&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- indicator datasets (parquet/CSV)<br>
            &nbsp;&nbsp;metadata/&nbsp;&nbsp;&nbsp;-- catalog and index files
          </div>

          <button type="button" id="saveSettingsBtn" class="settings-btn primary">Save Settings</button>
          <button type="button" id="initFoldersBtn" class="settings-btn secondary">Initialize Folders</button>

          <div id="settingsStatus" class="settings-status"></div>
        </div>

        <div class="settings-section">
          <h3>Display Settings</h3>

          <label for="timezoneSelect" style="font-size: 12px; font-weight: 500; display: block; margin-bottom: 5px; color: #d0d0d0;">
            Clock Timezone (for live mode):
          </label>
          <select id="timezoneSelect" class="settings-input" style="width: 100%; padding: 8px; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 4px;">
            <option value="local">Local (auto-detect)</option>
            <option value="UTC">UTC</option>
            <option value="America/Los_Angeles">Pacific (PST/PDT)</option>
            <option value="America/Denver">Mountain (MST/MDT)</option>
            <option value="America/Chicago">Central (CST/CDT)</option>
            <option value="America/New_York">Eastern (EST/EDT)</option>
            <option value="Europe/London">London (GMT/BST)</option>
            <option value="Europe/Paris">Paris (CET/CEST)</option>
            <option value="Asia/Tokyo">Tokyo (JST)</option>
            <option value="Asia/Shanghai">Shanghai (CST)</option>
            <option value="Australia/Sydney">Sydney (AEST/AEDT)</option>
          </select>
          <p style="font-size: 11px; color: #888; margin-top: 5px;">
            Sets the timezone for the live clock display. Data is stored in UTC.
          </p>
        </div>

        <div class="settings-section">
          <h3>Current Configuration</h3>
          <div id="currentConfig" style="font-size: 12px; color: #888;">
            Loading...
          </div>
        </div>
      </div>

      <div class="settings-footer">
        <a id="backToChat" href="#">Back to Chat</a>
      </div>
    </div>

    <!-- Sidebar Footer (in chat view) -->
    <div id="sidebarFooter">
      <a id="settingsLink" href="#">Settings</a>
    </div>
  </div>

  <!-- Map Container -->
  <div id="mapContainer">
    <div id="map"></div>
    <div id="breadcrumb"></div>
    <div id="globeToggle">
      <label><input type="checkbox" id="globeCheckbox"> Globe</label>
      <label><input type="checkbox" id="satCheckbox"> Sat</label>
    </div>
    <div id="zoomLevel">Zoom: 0.0</div>
    <div id="levelButtons">
      <button data-level="0" title="Countries (zoom ~2)">World</button>
      <button data-level="1" title="States/Provinces (zoom ~5)">States</button>
      <button data-level="2" title="Counties/Districts (zoom ~8)">Counties</button>
      <button data-level="3" title="Subdivisions (zoom ~11)">Local</button>
      <button id="levelLockBtn" title="Lock admin level">Lock</button>
    </div>

    <!-- Overlay Selector -->
    <div id="overlaySelector"></div>
  </div>

  <!-- Stats Overlay -->
  <div id="statsOverlay">
    <span id="totalAreas">0</span> areas
  </div>

  <!-- Time Slider -->
  <div id="timeSliderContainer">
    <!-- Metric tabs (shown when multiple metrics available) -->
    <div id="metricTabs" class="metric-tabs" style="display: none;"></div>
    <!-- Multi-scale tabs (hidden when only one scale) -->
    <div id="timeSliderTabs" class="time-slider-tabs" style="display: none;"></div>
    <div class="time-slider-header">
      <span class="time-slider-title" id="sliderTitle">Year</span>
      <span class="time-slider-year" id="currentYearLabel">2020</span>
      <span class="live-badge" id="liveBadge">LIVE</span>
    </div>
    <div class="time-slider-controls">
      <button id="stepBackBtn" class="time-btn" title="Previous year">&lt;</button>
      <button id="playBtn" class="time-btn play" title="Play/Pause">|&gt;</button>
      <button id="stepFwdBtn" class="time-btn" title="Next year">&gt;</button>
      <div class="slider-track-container">
        <div id="trimOverlayLeft" class="trim-overlay"></div>
        <div id="trimOverlayRight" class="trim-overlay"></div>
        <input type="range" id="timeSlider" min="2000" max="2023" value="2023">
        <div id="lowerTrimHandle" class="trim-handle" title="Drag to set start bound">
          <span class="trim-handle-label" id="lowerBoundLabel">2000</span>
        </div>
        <div id="upperTrimHandle" class="trim-handle" title="Drag to set end bound">
          <span class="trim-handle-label" id="upperBoundLabel">2023</span>
        </div>
      </div>
    </div>
    <div class="time-slider-labels">
      <label class="loop-control" title="Loop animation">
        <span>Loop</span>
        <input type="checkbox" id="loopCheckbox">
      </label>
      <span id="minYearLabel">2000</span>
      <button id="liveBtn" class="live-btn" title="Jump to current time and lock">LIVE</button>
      <span id="maxYearLabel">2023</span>
    </div>
    <!-- Speed Control (Phase 7 - Unified Speed Slider) -->
    <div class="speed-control">
      <span class="speed-label-left">Slow</span>
      <button id="speedDown" class="speed-step-btn" title="Decrease speed">-</button>
      <input type="range" id="speedSlider" min="0" max="1" step="0.01" value="0.72" title="Animation speed">
      <button id="speedUp" class="speed-step-btn" title="Increase speed">+</button>
      <span class="speed-label-right">Fast</span>
      <span id="speedLabel" class="speed-value">1yr/sec</span>
      <button id="clearBoundsBtn" class="bounds-clear-btn" title="Reset trim to full range">Reset Trim</button>
    </div>
  </div>

  <!-- Choropleth Legend -->
  <div id="choroplethLegend">
    <div class="legend-title" id="legendTitle">Value</div>
    <div class="legend-gradient" id="legendGradient"></div>
    <div class="legend-labels">
      <span id="legendMin">0</span>
      <span id="legendMax">100</span>
    </div>
  </div>

  <script src="https://unpkg.com/maplibre-gl@5.0.0/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/@msgpack/msgpack@3.0.0-beta2/dist.es5+umd/msgpack.min.js"></script>
  <script type="module" src="/static/modules/app.js"></script>
</body>
</html>
